<template>
  <main class="page page--grid">
    <div class="page-container">
      <theBreadcrumbs :list="breadcrumbs" />
      <akContainer />
      <!-- ÁÑ°ÈÅ∏ÊìáÁî¢ÂìÅÊôÇÔºåÈ°ØÁ§∫ÂÆåÊï¥ÂàóË°® -->
      <template v-if="!route.params.name || isModal">
        <h2>{{ pageTitle }}</h2>
        <!-- üîΩ ÁØ©ÈÅ∏ÂçÄÂ°ä -->
        <div class="filters">
          <span class="visually-hidden">{{ $t("words.changeByFilter") }}</span>
          <div>
            <label for="sortorder">{{ $t("words.sort") }}Ôºö</label>
            <select id="sortorder" v-model="sortorder">
              <option value="desc">{{ $t("words.newToOld") }}</option>
              <option value="asc">{{ $t("words.oldToNew") }}</option>
            </select>
          </div>
          <div>
            <label for="roleFilter">{{ $t("words.roles") }}Ôºö</label>
            <select id="roleFilter" v-model="selectedRole">
              <option value="">{{ $t("words.all") }}</option>
              <option v-for="role in uniqueRoles" :key="role" :value="role">
                {{ role }}
              </option>
            </select>
          </div>
          <div>
            <label for="platformFilter">{{ $t("words.platform") }}Ôºö</label>
            <select id="platformFilter" v-model="selectedPlatform">
              <option value="">{{ $t("words.all") }}</option>
              <option value="web">Web</option>
              <option value="app">App</option>
            </select>
          </div>
        </div>
        <!-- ÂàÜÁµÑÂæåÁöÑÁî¢ÂìÅÂàóË°® -->
        <div
          v-if="groupedlist.length > 0"
          :class="[
            'group-list',
            sortorder === 'desc'
              ? 'group-list--top-space'
              : 'group-list--bottom-space',
          ]"
          aria-live="polite"
        >
          <div class="group-year-present">{{ $t("words.today") }}</div>
          <div
            v-for="group in groupedlist"
            :key="group.year"
            class="portfolio-area"
          >
            <ul class="portfolio-list">
              <li
                v-for="(product, idx) in group.products"
                :key="product.id"
                class="portfolio-item animation-fade-out"
              >
                <nuxt-link
                  v-if="product.clickable"
                  :to="{
                    path: localePath(
                      `/products/${encodeURIComponent(product.slug)}`
                    ),
                    query: {
                      dialog: 'true',
                      role: selectedRole || undefined,
                      platform: selectedPlatform || undefined,
                      sortorder: sortorder || undefined,
                    },
                  }"
                  :title="`${product.name![$i18n.locale]}`"
                  class="portfolio-link"
                >
                  <h3 class="portfolio-title">
                    {{ product.name[$i18n.locale] }}
                  </h3>
                  <div class="portfolio-content">
                    <template v-if="idx === 0">
                      <img
                        v-if="product.heroImage[$i18n.locale]?.[0]?.src"
                        :src="`${product.heroImage[$i18n.locale][0]?.src}`"
                        alt=""
                        class="portfolio-img"
                        fetchpriority="high"
                      />
                    </template>
                    <template v-else>
                      <img
                        v-if="product.heroImage[$i18n.locale]?.[0]?.src"
                        :src="`${product.heroImage[$i18n.locale][0]?.src}`"
                        alt=""
                        class="portfolio-img"
                      />
                    </template>
                    <div
                      v-if="product.intro![$i18n.locale]"
                      class="portfolio-intro"
                    >
                      <p>{{ product.intro![$i18n.locale] }}</p>
                    </div>
                  </div>
                  <div class="portfolio-footer">
                    <span class="visually-hidden">
                      {{ $t("words.relatedTags") }}Ôºö
                    </span>
                    <span class="tag">
                      <span class="visually-hidden">
                        {{ $t("words.startToEnd") }}Ôºö
                      </span>
                      {{ formatYearRange(product.yearRange) }}
                    </span>
                    <span
                      v-if="
                        product.platform.includes('web') ||
                        product.platform.includes('app')
                      "
                      class="visually-hidden"
                    >
                      {{ $t("words.platformType") }}Ôºö
                    </span>
                    <span v-if="product.platform.includes('web')" class="tag">
                      Web
                    </span>
                    <span v-if="product.platform.includes('app')" class="tag">
                      App
                    </span>
                    <span
                      v-if="product.roles[$i18n.locale].length > 0"
                      class="visually-hidden"
                    >
                      {{ $t("words.roles") }}Ôºö
                    </span>
                    <span
                      v-for="(item, index) in product.roles[$i18n.locale]"
                      :key="index"
                      class="tag"
                    >
                      {{ item }}
                    </span>
                  </div>
                </nuxt-link>
                <div v-else class="portfolio-link portfolio-link--disabled">
                  <h3 class="portfolio-title">
                    {{ product.name[$i18n.locale] }}
                  </h3>
                  <div class="portfolio-content">
                    <img
                      :src="`${runtimeConfig.public.baseUrl}${product.heroImage[$i18n.locale][0]!.src}`"
                      :alt="product.name[$i18n.locale]"
                      class="portfolio-img"
                    />
                    <div
                      v-if="product.intro![$i18n.locale]"
                      class="portfolio-intro"
                    >
                      <p>{{ product.intro![$i18n.locale] }}</p>
                    </div>
                  </div>
                  <div class="portfolio-footer">
                    <span class="visually-hidden">
                      {{ $t("words.relatedTags") }}Ôºö
                    </span>
                    <span class="tag">
                      <span class="visually-hidden">
                        {{ $t("words.startToEnd") }}Ôºö
                      </span>
                      {{ formatYearRange(product.yearRange) }}
                    </span>
                    <span
                      v-if="
                        product.platform.includes('web') ||
                        product.platform.includes('app')
                      "
                      class="visually-hidden"
                    >
                      {{ $t("words.platformType") }}Ôºö
                    </span>
                    <span v-if="product.platform.includes('web')" class="tag">
                      Web
                    </span>
                    <span v-if="product.platform.includes('app')" class="tag">
                      App
                    </span>
                    <span
                      v-if="product.roles[$i18n.locale].length > 0"
                      class="visually-hidden"
                    >
                      {{ $t("words.roles") }}Ôºö
                    </span>
                    <span
                      v-for="(item, index) in product.roles[$i18n.locale]"
                      :key="index"
                      class="tag"
                    >
                      {{ item }}
                    </span>
                  </div>
                </div>
              </li>
            </ul>
            <div
              :class="[
                'group-year',
                sortorder === 'desc' ? 'group-year--bottom' : 'group-year--top',
              ]"
            >
              {{ group.year }}
            </div>
          </div>
        </div>
        <emptyBlock v-else>{{ $t("data.nodata") }}</emptyBlock>
      </template>

      <!-- ÈÅ∏Êìá‰∫ÜÁî¢ÂìÅ -->
      <template v-if="route.params.name && isModal">
        <!-- Áï∂ query.dialog ÁÇ∫ true ÊôÇÔºåÈ°ØÁ§∫ÂàóË°®Ëàá dialog -->
        <!-- <template v-if="isModal"> -->
        <dialog ref="lightBox" @cancel.prevent="closeProduct">
          <button
            type="button"
            class="btn btn--close-dialog"
            @click="closeProduct"
          >
            {{ t("action.closeDialog") }}
          </button>
          <NuxtPage />
        </dialog>
        <!-- </template> -->
        <!-- ÁÑ° query.dialogÔºåÁõ¥Êé•È°ØÁ§∫Ë©≥Á¥∞ÂÖßÂÆπ -->
      </template>
      <template v-if="route.params.name && !isModal">
        <NuxtPage />
      </template>
    </div>
  </main>
</template>

<script setup lang="ts">
import productsData from "~~/data/productsData";
const { t, locale } = useI18n();
const router = useRouter();
const route = useRoute();
const localePath = useLocalePath();
const lightBox = ref<HTMLDialogElement | null>(null);
const products = ref(productsData);
const runtimeConfig = useRuntimeConfig();
const pageTitle = computed(() => t("words.products"));
const pageDescription = computed(() => t("words.careerWorks"));

definePageMeta({
  scrollToTop: false,
});

// Êñ∞Â¢ûÊéíÂ∫èÁãÄÊÖãÔºåÈ†êË®≠ÁÇ∫Êñ∞Âà∞Ëàä (desc)
const sortorder = ref(
  route.query.sortorder ? String(route.query.sortorder) : "desc"
);

// **ÂæûÁ∂≤ÂùÄËÆÄÂèñÁØ©ÈÅ∏Ê¢ù‰ª∂**
const selectedRole = ref(route.query.role ? String(route.query.role) : ""); // ÂñÆÈÅ∏ËßíËâ≤
const selectedPlatform = ref(
  route.query.platform ? String(route.query.platform) : ""
); // ÂñÆÈÅ∏Âπ≥Âè∞Ôºàweb / appÔºâ

const isModal = computed(
  () => route.query.dialog === "true" && route.params.name
);

// üî• ÂèñÂæóÊâÄÊúâËßíËâ≤ÔºåÁîüÊàêÁØ©ÈÅ∏ÈÅ∏ÂñÆ
const uniqueRoles = computed(() => {
  const roleSet = new Set();
  products.value.forEach((p) => {
    p.roles[locale.value].forEach((role) => roleSet.add(role));
  });
  return Array.from(roleSet);
});

// üî• Êõ¥Êñ∞Á∂≤ÂùÄÁöÑ `query` ÂèÉÊï∏
const updateQueryParams = () => {
  router.replace({
    path: route.path,
    query: {
      role: selectedRole.value || undefined,
      platform: selectedPlatform.value || undefined,
      sortorder: sortorder.value || undefined,
    },
  });
};

// üî• Áõ£ËÅΩÁØ©ÈÅ∏Ê¢ù‰ª∂ËÆäÂåñÔºåÊõ¥Êñ∞Á∂≤ÂùÄÂèÉÊï∏
watch([selectedRole, selectedPlatform, sortorder], updateQueryParams);

// üî• Áõ£ËÅΩÁ∂≤ÂùÄ `query` ËÆäÂåñÔºåÁï∂‰ΩøÁî®ËÄÖ‰øÆÊîπÁ∂≤ÂùÄÊôÇÔºåËá™ÂãïÊõ¥Êñ∞ÁØ©ÈÅ∏Ê¢ù‰ª∂
watch(
  () => route.query,
  (query) => {
    selectedRole.value = query.role ? String(query.role) : "";
    selectedPlatform.value = query.platform ? String(query.platform) : "";
    sortorder.value = query.sortorder ? String(query.sortorder) : "desc";
  }
);

// ÁØ©ÈÅ∏Áî¢ÂìÅ computed Â±¨ÊÄß (‰øùÁïôÂéüÊúâÊéíÂ∫èÈÇèËºØ)
const filteredList = computed(() => {
  return products.value
    .filter((p) => {
      const matchesRole =
        selectedRole.value === "" ||
        p.roles[locale.value].includes(selectedRole.value);
      const matchesPlatform =
        selectedPlatform.value === "" ||
        p.platform.includes(selectedPlatform.value);

      return matchesRole && matchesPlatform;
    })
    .sort((a, b) => {
      if (sortorder.value === "asc") {
        return a.yearRange.start - b.yearRange.start;
      } else {
        return b.yearRange.start - a.yearRange.start;
      }
    });
});

// Êñ∞Â¢û‰æùÊìö yearRange.start ÂàÜÁµÑÁöÑ computed Â±¨ÊÄß
const groupedlist = computed(() => {
  const groups: { products: typeof products.value }[] = [];

  filteredList.value.forEach((product) => {
    const year = product.yearRange.start;
    let group = groups.find((g) => g.year === year);
    if (!group) {
      group = { year, products: [] };
      groups.push(group);
    }
    group.products.push(product);
  });

  // Ê†πÊìö sortorder ÊéíÂ∫èÂàÜÁµÑÔºåËã•ÁÇ∫ asc ÂâáÁî±Â∞èÂà∞Â§ßÔºåÂê¶ÂâáÁî±Â§ßÂà∞Â∞è
  groups.sort((a, b) => {
    if (sortorder.value === "asc") {
      return a.year - b.year;
    } else {
      return b.year - a.year;
    }
  });

  return groups;
});

// üî• ËΩâÊèõÂπ¥‰ªΩÊ†ºÂºè
const formatYearRange = (yearRange: { start: number; end: number | null }) => {
  return yearRange.end === null
    ? `${yearRange.start} - ` + t("words.present")
    : `${yearRange.start} - ${yearRange.end}`;
};

// ÈóúÈñâ dialog ÊôÇÔºåÂ∞éÂêëËá≥ "/products" Ê∏ÖÈô§ encodedName Ëàá query ÂèÉÊï∏
const closeProduct = async () => {
  lightBox.value?.close();
  await router.replace({
    path: localePath("/products"),
    query: {
      role: selectedRole.value || undefined,
      platform: selectedPlatform.value || undefined,
      sortorder: sortorder.value || undefined,
    },
  });
};

// Áõ£ËÅΩ route.fullPathÔºåËã•‰∏çÁ¨¶ÂêàÊ¢ù‰ª∂ÂâáÈóúÈñâ dialog
watch(
  () => route.fullPath,
  () => {
    if (!isModal.value) {
      lightBox.value?.close();
    }
  }
);

// Áõ£ËÅΩ isModalÔºåÁï∂ÂÖ∂ËÆäÁÇ∫ `true` ÊôÇÔºåÈñãÂïü dialog
watch(isModal, async (modal) => {
  if (modal) {
    await nextTick();
    lightBox.value?.showModal();

    // Á≠âÈ¶ñÂ±èÂÖàÁï´Âá∫ÔºåÂÜçÊ∏ÖÊéâ queryÔºàÈÅøÂÖçÈòªÂ°ûÔºâ
    requestAnimationFrame(() => {
      // Âè™ÊîπÁ∂≤ÂùÄÔºå‰∏çËß∏ÁôºÂ∞éËà™
      window.history.replaceState(window.history.state, "", route.path);
    });
  }
});

onMounted(() => {
  if (isModal.value) {
    lightBox.value?.showModal();
  }
});

const orgUrl = computed(() => {
  if (locale.value === "en") {
    return `${runtimeConfig.public.baseUrl}/en`;
  } else {
    return `${runtimeConfig.public.baseUrl}`;
  }
});

// üî• Ë®≠ÂÆö Schema.org Ë≥áÊñô
useSchemaOrg([
  // ‰ΩúÂìÅÈõÜÂàóË°® (ItemList)
  {
    "@context": "https://schema.org",
    "@type": "ItemList",
    "@id": `${runtimeConfig.public.baseUrl}${route.path}#productsList`,
    name: t("words.portfolio"),
    description: pageDescription.value,
    url: `${runtimeConfig.public.baseUrl}${route.path}`,
    numberOfItems: productsData.length,
    itemListElement: productsData.map((work, index) => ({
      "@type": "ListItem",
      position: index + 1,
      url: `${orgUrl.value}/products/${work.slug}`,
      item: {
        "@type": "CreativeWork",
        "@id": `${orgUrl.value}/products/${work.slug}#creativework`,
        name: work.name[locale.value],
        description: work.intro?.[locale.value] || "",
        image: `${runtimeConfig.public.baseUrl}${work.schemaImage[locale.value][0]?.src}`,
        creator: {
          "@type": "Person",
          name: "Neil",
          url: orgUrl.value,
        },
        datePublished: work.yearRange.start,
        dateModified: work.yearRange.end ?? new Date().getFullYear(),
        url: `${orgUrl.value}/products/${work.slug}`,
        inLanguage: locale.value,
        keywords: work.roles[locale.value].join(", "),
        audience: {
          "@type": "EducationalAudience",
          educationalRole: "Designer, Developer",
        },
      },
    })),
  },
]);

useHead({
  title: pageTitle,
  meta: [
    {
      hid: "description",
      name: "description",
      content: pageDescription.value,
    },
    {
      hid: "og:url",
      property: "og:url",
      content: runtimeConfig.public.baseUrl + route.path,
    },
    {
      hid: "og:title",
      property: "og:title",
      content: pageTitle.value + " - " + t("website.name"),
    },
    {
      hid: "og:description",
      property: "og:description",
      content: pageDescription.value,
    },
    {
      hid: "twitter:url",
      name: "twitter:url",
      content: runtimeConfig.public.baseUrl + route.path,
    },
    {
      hid: "twitter:title",
      name: "twitter:title",
      content: pageTitle.value + " - " + t("website.name"),
    },
    {
      hid: "twitter:description",
      name: "twitter:description",
      content: pageDescription.value,
    },
  ],
});

const slug = route.params.name;
const product = productsData.find((p) => p.slug === slug);

const breadcrumbs = computed(() => {
  if (slug && product) {
    return [
      { link: "/", title: String(t("action.goToHomePage")) },
      { link: "/products", title: String(t("mainMenu.products")) },
      { title: String(product.name[locale.value] || slug) },
    ];
  } else {
    return [
      { link: "/", title: String(t("action.goToHomePage")) },
      { title: String(t("mainMenu.products")) },
    ];
  }
});

watchEffect(() => {
  if (breadcrumbs.value.length > 0) {
    useBreadcrumbSchema(breadcrumbs.value);
  }
});

defineOgImageComponent("OgImageCustomTemplate", {
  title: pageTitle.value + " - " + t("website.name"),
});
</script>

<style scoped>
.page-container {
  grid-column: 4 / -4;
  @media screen and (width <= 1920px) {
    grid-column: 2 / -2;
  }
  @media screen and (width <= 768px) {
    grid-column: 1 / -1;
  }
}

.group-list {
  @media screen and (width <= 768px) {
    margin-left: 3rem;
  }
}

.btn--close-dialog {
  position: sticky;
  top: 0;
}
</style>
